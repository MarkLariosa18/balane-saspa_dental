<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Admin</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <link href="assets/img/logo.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    .recent-appointments-filter {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .search-container {
      flex: 1;
      min-width: 200px;
    }
    .search-container input {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    .search-container input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    .recent-appointments-filter select {
      padding: 8px 12px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    .recent-appointments-filter select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    th.sortable {
      cursor: pointer;
      position: relative;
      padding-right: 20px;
    }
    th.sortable::after {
      content: '\25B2'; /* Up arrow */
      position: absolute;
      right: 5px;
      opacity: 0.3;
    }
    th.sortable::before {
      content: '\25BC'; /* Down arrow */
      position: absolute;
      right: 10px;
      opacity: 0.3;
    }
    th.sortable.asc::after {
      opacity: 1;
    }
    th.sortable.desc::before {
      opacity: 1;
    }
  </style>
</head>

<body>

  <!-- ======= Header ======= -->
  <div id="head_content"></div>

  <main id="main" class="main">

    <div class="pagetitle">
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
          <li class="breadcrumb-item active">History</li>
        </ol>
      </nav>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <div class="recent-appointments-filter">
                <label for="statusFilter">Status: </label>
                <select id="statusFilter">
                  <option value="all">All Statuses</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="rejected">Rejected</option>
                  <option value="expired">Expired</option>
                </select>
                <label for="serviceTableFilter">Service: </label>
                <select id="serviceTableFilter">
                  <option value="all">All Services</option>
                  <!-- Populated dynamically -->
                </select>
                <div class="search-container">
                  <input type="text" id="searchInput" placeholder="Search by patient, service, or date...">
                </div>
                <div class="action-buttons">
                  <button id="showAllBtn" class="btn btn-primary btn-sm">Show All</button>
                  <button id="exportCsvBtn" class="btn btn-success btn-sm">Export as CSV</button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th class="sortable" data-sort="id">ID</th>
                      <th class="sortable" data-sort="name">Name</th>
                      <th class="sortable" data-sort="address">Address</th>
                      <th class="sortable" data-sort="sex">Sex</th>
                      <th class="sortable" data-sort="age">Age</th>
                      <th class="sortable" data-sort="contact">Contact No.</th>
                      <th class="sortable" data-sort="email">Email</th>
                      <th class="sortable" data-sort="date">Appointment Date</th>
                      <th class="sortable" data-sort="service">Service</th>
                      <th class="sortable" data-sort="status">Status</th>
                    </tr>
                  </thead>
                  <tbody id="appointmentTableBody">
                    <!-- Table rows will be populated dynamically -->
                  </tbody>
                </table>
              </div>

              <div class="pagination d-flex justify-content-center mt-3" id="paginationContainer">
                <nav aria-label="Page navigation">
                  <ul class="pagination" id="pagination">
                    <!-- Pagination will be populated dynamically -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <div id="foot_content"></div>

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <script src="assets/js/main.js"></script>
  <script type="text/javascript">
    $('#head_content').load('header.html');
    $('#foot_content').load('footer.html');

    $(document).ready(function() {
      const itemsPerPage = 10;
      let currentPage = 1;
      let combinedData = [];
      let allServices = [];
      let sortColumn = null;
      let sortDirection = 'asc';
      let isShowingAll = false;

      // Utility Functions
      function calculateAge(birthdate) {
        if (!birthdate) return 'N/A';
        const today = new Date();
        const birth = new Date(birthdate);
        const age = Math.floor((today - birth) / (365.25 * 24 * 60 * 60 * 1000));
        return age >= 0 ? age : 'N/A';
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString('en-US', {
          year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });
      }

      function escapeCsvValue(value) {
        if (value === null || value === undefined) return '';
        const str = String(value);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }

      function exportToCsv(data) {
        const headers = ['ID', 'Name', 'Address', 'Sex', 'Age', 'Contact No.', 'Email', 'Appointment Date', 'Service', 'Status'];
        const csvRows = [];

        // Add headers
        csvRows.push(headers.map(escapeCsvValue).join(','));

        // Add data rows
        data.forEach(item => {
          const row = [
            item.id,
            item.name,
            item.address,
            item.sex,
            item.age,
            item.contact,
            item.email,
            formatDate(item.appointment_date),
            item.service,
            item.status
          ];
          csvRows.push(row.map(escapeCsvValue).join(','));
        });

        // Create CSV content
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'appointment_history.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      // Merge Patients and Appointments
      function mergeData(patients, appointments) {
        const patientMap = new Map(patients.map(p => [p.id, p]));
        console.log('Patient Map:', Array.from(patientMap.entries()));
        return appointments.map(app => {
          const patient = patientMap.get(app.user_id) || {};
          console.log(`Merging appointment ${app.id} with user_id ${app.user_id}, found patient:`, patient);
          return {
            id: app.id || 'N/A',
            name: patient.name || `${app.patients?.first_name || 'N/A'} ${app.patients?.last_name || 'N/A'}`.trim(),
            address: patient.address || 'N/A',
            sex: patient.sex || 'N/A',
            age: patient.age || calculateAge(app.patients?.birthdate),
            contact: patient.contact || app.patients?.mobile_no || 'N/A',
            email: patient.email || app.patients?.email || 'N/A',
            appointment_date: app.appointment_date || 'N/A',
            service: app.services?.name || 'N/A',
            status: app.status || 'N/A'
          };
        });
      }

      // Populate Table
      function populateTable(data, page) {
        const tbody = $('#appointmentTableBody');
        tbody.empty();

        let dataToShow = data;
        if (!isShowingAll) {
          const start = (page - 1) * itemsPerPage;
          const end = start + itemsPerPage;
          dataToShow = data.slice(start, end);
        }

        if (dataToShow.length === 0) {
          tbody.append('<tr><td colspan="10">No matching records found</td></tr>');
          return;
        }

        dataToShow.forEach(item => {
          const statusClass = {
            'confirmed': 'bg-success',
            'pending': 'bg-warning text-dark',
            'cancelled': 'bg-danger',
            'rejected': 'bg-danger',
            'expired': 'bg-secondary'
          }[item.status.toLowerCase()] || 'bg-secondary';

          const row = `
            <tr>
              <td>${item.id}</td>
              <td>${item.name}</td>
              <td>${item.address}</td>
              <td>${item.sex}</td>
              <td>${item.age}</td>
              <td>${item.contact}</td>
              <td>${item.email}</td>
              <td>${formatDate(item.appointment_date)}</td>
              <td>${item.service}</td>
              <td><span class="badge ${statusClass}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span></td>
            </tr>
          `;
          tbody.append(row);
        });

        if (!isShowingAll) {
          updatePagination(data.length, page);
        } else {
          $('#paginationContainer').hide();
        }
      }

      // Update Pagination
      function updatePagination(totalItems, page) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pagination = $('#pagination');
        pagination.empty();

        if (totalPages <= 1) {
          $('#paginationContainer').hide();
          return;
        }

        $('#paginationContainer').show();
        pagination.append(`
          <li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" aria-label="Previous" data-page="${page - 1}">
              <span aria-hidden="true">«</span>
            </a>
          </li>
        `);

        for (let i = 1; i <= totalPages; i++) {
          pagination.append(`
            <li class="page-item ${i === page ? 'active' : ''}">
              <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
          `);
        }

        pagination.append(`
          <li class="page-item ${page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" aria-label="Next" data-page="${page + 1}">
              <span aria-hidden="true">»</span>
            </a>
          </li>
        `);

        $('.page-link').off('click').on('click', function(e) {
          e.preventDefault();
          const newPage = $(this).data('page');
          if (newPage && newPage > 0 && newPage <= totalPages) {
            currentPage = newPage;
            isShowingAll = false;
            $('#showAllBtn').text('Show All');
            filterAndPopulateTable();
          }
        });
      }

      // Filter Data (Updated to search only name, address, service, and date)
      function filterData() {
        const statusFilter = $('#statusFilter').val();
        const serviceFilter = $('#serviceTableFilter').val();
        const searchQuery = $('#searchInput').val().toLowerCase().trim();

        return combinedData.filter(item => {
          const matchesStatus = statusFilter === 'all' || item.status.toLowerCase() === statusFilter;
          const matchesService = serviceFilter === 'all' || item.service === serviceFilter;
          const matchesSearch = 
            item.name.toLowerCase().includes(searchQuery) ||
            item.address.toLowerCase().includes(searchQuery) ||
            item.service.toLowerCase().includes(searchQuery) ||
            formatDate(item.appointment_date).toLowerCase().includes(searchQuery);
          return matchesStatus && matchesService && matchesSearch;
        });
      }

      // Sort Data
      function sortData(data) {
        if (!sortColumn) return data;

        return [...data].sort((a, b) => {
          let valA, valB;
          switch (sortColumn) {
            case 'id':
              valA = a.id || '';
              valB = b.id || '';
              break;
            case 'name':
              valA = a.name || '';
              valB = b.name || '';
              break;
            case 'address':
              valA = a.address || '';
              valB = b.address || '';
              break;
            case 'sex':
              valA = a.sex || '';
              valB = b.sex || '';
              break;
            case 'age':
              valA = a.age === 'N/A' ? -1 : a.age;
              valB = b.age === 'N/A' ? -1 : b.age;
              break;
            case 'contact':
              valA = a.contact || '';
              valB = b.contact || '';
              break;
            case 'email':
              valA = a.email || '';
              valB = b.email || '';
              break;
            case 'date':
              valA = new Date(a.appointment_date);
              valB = new Date(b.appointment_date);
              break;
            case 'service':
              valA = a.service || '';
              valB = b.service || '';
              break;
            case 'status':
              valA = a.status || '';
              valB = b.status || '';
              break;
            default:
              return 0;
          }

          if (typeof valA === 'string' && typeof valB === 'string') {
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          }
          return sortDirection === 'asc' ? valA - valB : valB - valA;
        });
      }

      // Filter and Populate Table
      function filterAndPopulateTable() {
        let filteredData = filterData();
        filteredData = sortData(filteredData);
        currentPage = Math.min(currentPage, Math.max(1, Math.ceil(filteredData.length / itemsPerPage)));
        populateTable(filteredData, currentPage);
      }

      // Fetch Patients
      function fetchPatients(callback) {
        console.log('Fetching patients from /patients/allPatients');
        $.ajax({
          url: '/patients/allPatients',
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('authToken')
          },
          success: function(response) {
            console.log('Raw patients response:', response);
            const patients = response || [];
            console.log('Patients fetched:', patients);
            callback(patients);
          },
          error: function(xhr, status, error) {
            console.error('Error fetching patients:', status, error, 'Response:', xhr.responseText);
            $('#appointmentTableBody').html('<tr><td colspan="10">Failed to load patient data - ' + status + ': ' + xhr.responseText + '</td></tr>');
            callback([]);
          }
        });
      }

      // Fetch Appointments
      function fetchAppointments(callback) {
        console.log('Fetching appointments from /api/appointments/all');
        $.ajax({
          url: '/api/appointments/all',
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('authToken')
          },
          success: function(response) {
            const appointments = response.appointments || [];
            console.log('Raw appointments response:', response);
            console.log('Appointments fetched:', appointments);
            callback(appointments);
          },
          error: function(xhr, status, error) {
            console.error('Error fetching appointments:', status, error, 'Response:', xhr.responseText);
            $('#appointmentTableBody').html('<tr><td colspan="10">Failed to load appointment data - ' + status + ': ' + xhr.responseText + '</td></tr>');
            callback([]);
          }
        });
      }

      // Test Encryption
      function testEncryption() {
        console.log('Testing encryption via /api/appointments/test-encryption');
        $.ajax({
          url: '/api/appointments/test-encryption',
          method: 'GET',
          success: function(response) {
            console.log('Encryption test:', response);
          },
          error: function(xhr, status, error) {
            console.error('Encryption test failed:', status, error, 'Response:', xhr.responseText);
          }
        });
      }

      // Initialize Data Fetching
      function initializeData() {
        testEncryption();
        fetchPatients(function(patients) {
          fetchAppointments(function(appointments) {
            combinedData = mergeData(patients, appointments);

            // Populate service filter
            allServices = [...new Set(combinedData.map(item => item.service).filter(name => name !== 'N/A'))];
            const serviceFilter = $('#serviceTableFilter');
            serviceFilter.empty().append('<option value="all">All Services</option>');
            allServices.forEach(service => {
              serviceFilter.append(`<option value="${service}">${service}</option>`);
            });

            filterAndPopulateTable();
          });
        });
      }

      // Sorting Event Listener
      $('.sortable').on('click', function() {
        const column = $(this).data('sort');
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }

        $('.sortable').removeClass('asc desc');
        $(this).addClass(sortDirection);
        filterAndPopulateTable();
      });

      // Show All Event Listener
      $('#showAllBtn').on('click', function() {
        isShowingAll = !isShowingAll;
        $(this).text(isShowingAll ? 'Show Paginated' : 'Show All');
        filterAndPopulateTable();
      });

      // Export as CSV Event Listener
      $('#exportCsvBtn').on('click', function() {
        exportToCsv(combinedData);
      });

      // Debounce for Search
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Event Listeners for Filters
      const debouncedFilter = debounce(filterAndPopulateTable, 300);
      $('#searchInput').on('input', function() {
        currentPage = 1;
        debouncedFilter();
      });
      $('#statusFilter, #serviceTableFilter').on('change', function() {
        currentPage = 1;
        debouncedFilter();
      });

      // Initial Fetch
      initializeData();
    });
  </script>
</body>

</html>