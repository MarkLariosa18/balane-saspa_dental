<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Admin</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <link href="assets/img/icon.png" rel="icon">

  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
  <link href="assets/css/calendar.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.tiny.cloud/1/YOUR_API_KEY/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <style>
    .toggle-sidebar-btn {
      font-size: 1.5rem;
      cursor: pointer;
      display: none;
      color: #333;
    }

    @media (max-width: 1199px) {
      .header { padding: 10px 15px; }
      .header-nav .nav-item:not(.dropdown) { display: none; }
      .sidebar { position: fixed; left: -250px; width: 250px; height: 100%; transition: all 0.3s ease; z-index: 1000; background: #fff; }
      .sidebar.active { left: 0; }
      .toggle-sidebar-btn { display: inline-block !important; }
      .header-nav { margin-left: 0; }
      .dropdown-menu { width: 100%; max-width: 300px; right: 0 !important; }
      .modal-content { width: 90%; margin: 0 auto; }
      .logo span { display: none; }
    }

    @media (min-width: 1200px) {
      .sidebar { position: fixed; left: 0; }
      .toggle-sidebar-btn { display: none !important; }
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      transition: opacity 0.3s ease;
      opacity: 0;
    }
    .overlay.active {
      display: block;
      opacity: 1;
    }

    /* Modal Styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1050;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 500px;
      width: 100%;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }

    /* Ensure dropdown visibility */
    .dropdown-menu {
      display: none;
      z-index: 1050;
      min-width: 300px;
      max-height: 400px;
      overflow-y: auto;
    }
    .dropdown-menu.show {
      display: block !important;
    }

    .nav-link.nav-icon {
      cursor: pointer;
      position: relative;
    }

    .notification-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .notification-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="overlay" id="sidebarOverlay"></div>

  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center">
      <i class="bi bi-list toggle-sidebar-btn me-2"></i>
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/icon.png" alt="">
        <span class="d-none d-lg-block">Admin</span>
      </a>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown" id="notificationDropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number" id="notificationCount">0</span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications" id="notificationsList">
            <li class="dropdown-header">
              <span id="notificationHeaderCount">0</span> Pending Cancel Requests
              <a href="notification.html"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
            </li>
            <li class="items-container">
              <hr class="dropdown-divider">
            </li>
            <li class="dropdown-footer">
              <a href="notification.html">Show all notifications</a>
            </li>
          </ul>
        </li>

        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-2" style="font-size: 1.5rem; color: #6c757d;"></i>
            <span class="d-none d-md-block dropdown-toggle ps-2">Menu</span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li><a class="dropdown-item d-flex align-items-center" href="setting.html"><i class="bi bi-person"></i><span>Profile</span></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item d-flex align-items-center" href="setting.html"><i class="bi bi-gear"></i><span>Settings</span></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item d-flex align-items-center" href="/logout" id="logoutBtn"><i class="bi bi-box-arrow-right"></i><span>Sign Out</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <div class="modal" id="actionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Process Cancel Request</h3>
        <button class="close-modal" onclick="closeActionModal()">Ã—</button>
      </div>
      <div id="requestDetails" class="p-3"></div>
      <div class="button-group">
        <button class="approve-btn btn btn-success" onclick="acceptCancel()">Accept</button>
        <button class="reject-btn btn btn-danger" onclick="rejectCancel()">Reject</button>
      </div>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <nav id="navmenu" class="navmenu">
      <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item"><a class="nav-link collapsed" href="index.html"><i class="bi bi-grid"></i><span>Dashboard</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="appointment.html"><i class="bi bi-grid"></i><span>Appointment</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="patients.html"><i class="bi bi-person"></i><span>Patients</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="notification.html"><i class="bi bi-grid"></i><span>Notification</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="history.html"><i class="bi bi-grid"></i><span>History</span></a></li>
        <li class="nav-item"><a class="nav-link collapsed" href="setting.html"><i class="bi bi-grid"></i><span>Settings</span></a></li>
      </ul>
      <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
    </nav>
  </aside>

  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    if (typeof bootstrap === 'undefined') {
      console.warn('Local Bootstrap JS failed to load, falling back to CDN');
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
      script.integrity = 'sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz';
      script.crossOrigin = 'anonymous';
      document.head.appendChild(script);
    }
  </script>
  <script src="assets/vendor/chart.js/chart.umd.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/vendor/quill/quill.js"></script>
  <script src="assets/js/notifications.js"></script>

  <script>
    (function() {
      console.log('Header script loaded');

      setTimeout(() => {
        console.log('Testing Bootstrap dropdown after delay');
        if (typeof bootstrap === 'undefined') {
          console.error('Bootstrap JavaScript not loaded');
        } else {
          console.log('Bootstrap JavaScript loaded');
          const dropdownElement = document.getElementById('notificationDropdown');
          const dropdownMenu = document.getElementById('notificationsList');
          if (dropdownElement && dropdownMenu) {
            console.log('Notification dropdown elements found');
            dropdownElement.addEventListener('click', () => {
              console.log('Notification dropdown clicked');
            });
            dropdownElement.addEventListener('shown.bs.dropdown', () => {
              console.log('Notification dropdown shown');
            });
            dropdownElement.addEventListener('hidden.bs.dropdown', () => {
              console.log('Notification dropdown hidden');
            });
          } else {
            console.error('Notification dropdown elements not found:', {
              dropdownElement: !!dropdownElement,
              dropdownMenu: !!dropdownMenu
            });
          }
        }
      }, 1000);

      let socket;
      let cancelRequests = [];
      let currentRequest = null;
      let pollingInterval = null;
      let consecutiveFetchFailures = 0;
      const MAX_CONSECUTIVE_FAILURES = 5;

      function initializeWebSocket() {
        try {
          socket = new WebSocket('ws://localhost:3000');
          console.log('Attempting to connect to WebSocket at ws://localhost:3000');
        } catch (error) {
          console.error('WebSocket initialization failed:', error);
          return;
        }

        socket.onopen = () => {
          console.log('WebSocket connection established');
          consecutiveFetchFailures = 0;
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log('Polling stopped due to WebSocket connection');
          }
        };

        socket.onmessage = (event) => {
          console.log('WebSocket message received:', event.data);
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'cancel_request' && data.request.pending_action === 'cancel') {
              console.log('New cancel request received via WebSocket:', data.request);
              if (!cancelRequests.some(req => req.id === data.request.id)) {
                cancelRequests.push(data.request);
                updateCancelRequests();
                document.getElementById('notificationDropdown').click();
              } else {
                console.log('Cancel request already exists in list:', data.request.id);
              }
            } else {
              console.log('Received WebSocket message is not a cancel request:', data);
            }
          } catch (error) {
            console.error('Error parsing WebSocket message:', error);
          }
        };

        socket.onerror = (error) => {
          console.error('WebSocket error:', error);
        };

        socket.onclose = (event) => {
          console.log('WebSocket connection closed:', event.code, event.reason);
          setTimeout(() => {
            console.log('Attempting to reconnect to WebSocket');
            initializeWebSocket();
          }, 5000);
        };
      }

      $(document).ready(() => {
        console.log('DOM loaded in header, initializing WebSocket and notifications');

        initializeWebSocket();

        console.log('Initial fetch of pending cancel requests');
        fetchPendingCancelRequests();

        setTimeout(() => {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            console.warn('WebSocket not available after initialization, falling back to polling...');
            if (!pollingInterval) {
              pollingInterval = setInterval(() => {
                console.log('Polling for pending cancel requests');
                fetchPendingCancelRequests();
              }, 10000);
            }
          } else {
            console.log('WebSocket is connected, no need for polling');
          }
        }, 1000);

        const toggleSidebarBtn = document.querySelector('.toggle-sidebar-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (toggleSidebarBtn && sidebar && overlay) {
          toggleSidebarBtn.addEventListener('click', () => {
            console.log('Toggling sidebar');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
          });

          overlay.addEventListener('click', () => {
            console.log('Closing sidebar via overlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
          });
        } else {
          console.error('Sidebar toggle elements not found:', {
            toggleSidebarBtn: !!toggleSidebarBtn,
            sidebar: !!sidebar,
            overlay: !!overlay
          });
        }
      });

      window.addEventListener('load', () => {
        console.log('Window loaded, ensuring notifications are fetched');
        fetchPendingCancelRequests();
      });

      function updateCancelRequests() {
        const count = document.getElementById('notificationCount');
        const headerCount = document.getElementById('notificationHeaderCount');
        const list = document.getElementById('notificationsList');
        const itemsContainer = list ? list.querySelector('.items-container') : null;

        if (!count || !headerCount || !list || !itemsContainer) {
          console.error('Notification elements not found:', {
            count: !!count,
            headerCount: !!headerCount,
            list: !!list,
            itemsContainer: !!itemsContainer
          });
          return;
        }

        count.textContent = cancelRequests.length;
        headerCount.textContent = cancelRequests.length;
        console.log('Updating cancel requests, count:', cancelRequests.length, 'requests:', cancelRequests);

        const existingItems = itemsContainer.querySelectorAll('.notification-item');
        existingItems.forEach(item => item.remove());

        const existingDividers = itemsContainer.querySelectorAll('.dropdown-divider');
        existingDividers.forEach((divider, index) => {
          if (index > 0) divider.remove();
        });

        if (cancelRequests.length === 0) {
          const noItems = document.createElement('li');
          noItems.className = 'notification-item';
          noItems.textContent = 'No pending cancel requests';
          itemsContainer.appendChild(noItems);
          itemsContainer.appendChild(document.createElement('hr')).className = 'dropdown-divider';
        } else {
          cancelRequests.forEach((request, index) => {
            const patientData = request.patients || {};
            const patientName = `${patientData.first_name || ''} ${patientData.last_name || ''}`.trim() || 'Unknown';

            const item = document.createElement('li');
            item.className = 'notification-item';
            item.innerHTML = `
              <div>
                <h4>Cancel Request #${request.id}</h4>
                <p>${patientName}</p>
                <p>${new Date(request.appointment_date).toLocaleString()}</p>
                <p>${request.services?.name || 'N/A'}</p>
                <a href="notification.html" class="btn btn-sm btn-primary">Review</a>
              </div>
            `;
            itemsContainer.appendChild(item);
            itemsContainer.appendChild(document.createElement('hr')).className = 'dropdown-divider';
          });
        }
      }

      function showActionModal(index) {
        currentRequest = cancelRequests[index];
        const patientData = currentRequest.patients || {};
        const patientName = `${patientData.first_name || ''} ${patientData.last_name || ''}`.trim() || 'Unknown';

        const requestDetails = document.getElementById('requestDetails');
        if (requestDetails) {
          requestDetails.innerHTML = `
            <p><strong>Request #${currentRequest.id}</strong></p>
            <p>Patient: ${patientName}</p>
            <p>Date: ${new Date(currentRequest.appointment_date).toLocaleString()}</p>
            <p>Service: ${currentRequest.services?.name || 'N/A'}</p>
          `;
        } else {
          console.error('Request details element not found');
        }

        const actionModal = document.getElementById('actionModal');
        if (actionModal) {
          actionModal.style.display = 'none';
          actionModal.classList.remove('show');
          setTimeout(() => {
            actionModal.style.display = 'flex';
            actionModal.classList.add('show');
          }, 10);
        } else {
          console.error('Action modal element not found');
        }

        const dropdownElement = document.getElementById('notificationDropdown');
        if (dropdownElement && typeof bootstrap !== 'undefined') {
          const dropdown = bootstrap.Dropdown.getInstance(dropdownElement);
          if (dropdown) {
            dropdown.hide();
            console.log('Dropdown closed after opening modal');
          }
        }
        console.log('Showing action modal for request:', currentRequest);
      }

      function closeActionModal() {
        const actionModal = document.getElementById('actionModal');
        if (actionModal) {
          actionModal.style.display = 'none';
          actionModal.classList.remove('show');
        }
        currentRequest = null;
        console.log('Action modal closed');
      }

      async function acceptCancel() {
        if (!currentRequest) {
          console.error('No current request to accept');
          return;
        }
        try {
          console.log('Accepting cancel request:', currentRequest.id);
          const response = await fetch(`/api/appointments/${currentRequest.id}/action`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ pending_action: null, status: 'cancelled' })
          });
          if (response.ok) {
            console.log('Cancel request accepted:', currentRequest.id);
            cancelRequests = cancelRequests.filter(r => r.id !== currentRequest.id);
            updateCancelRequests();
            closeActionModal();
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(JSON.stringify({
                type: 'cancel_response',
                requestId: currentRequest.id,
                status: 'cancelled'
              }));
            }
            if (window.location.pathname.includes('index.html')) {
              window.location.reload();
            }
          } else {
            const error = await response.text();
            console.error('Failed to accept cancellation:', error);
            alert('Failed to accept cancellation: ' + error);
          }
        } catch (error) {
          console.error('Error accepting cancellation:', error);
          alert('Error processing request');
        }
      }

      async function rejectCancel() {
        if (!currentRequest) {
          console.error('No current request to reject');
          return;
        }
        try {
          console.log('Rejecting cancel request:', currentRequest.id);
          const response = await fetch(`/api/appointments/${currentRequest.id}/action`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ pending_action: null, status: 'confirmed' })
          });
          if (response.ok) {
            console.log('Cancel request rejected:', currentRequest.id);
            cancelRequests = cancelRequests.filter(r => r.id !== currentRequest.id);
            updateCancelRequests();
            closeActionModal();
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(JSON.stringify({
                type: 'cancel_response',
                requestId: currentRequest.id,
                status: 'confirmed'
              }));
            }
          } else {
            const error = await response.text();
            console.error('Failed to reject cancellation:', error);
            alert('Failed to reject cancellation: ' + error);
          }
        } catch (error) {
          console.error('Error rejecting cancellation:', error);
          alert('Error processing request');
        }
      }

      async function fetchPendingCancelRequests() {
        try {
          console.log('Fetching pending cancel requests from /api/appointments/pending-action');
          const response = await fetch('/api/appointments/pending-action', {
            credentials: 'include',
            headers: {
              'Accept': 'application/json'
            }
          });
          console.log('Response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('Pending cancel requests response:', data);
            cancelRequests = data.filter(req => req.pending_action === 'cancel');
            console.log('Filtered cancel requests:', cancelRequests);
            updateCancelRequests();
            consecutiveFetchFailures = 0;
          } else {
            const errorText = await response.text();
            console.error('Failed to fetch pending cancel requests:', response.status, errorText);
            consecutiveFetchFailures++;
            console.log('Consecutive fetch failures:', consecutiveFetchFailures);
            if (consecutiveFetchFailures >= MAX_CONSECUTIVE_FAILURES) {
              console.error('Too many consecutive fetch failures, stopping polling');
              if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                alert('Unable to fetch notifications due to repeated server errors. Please contact support.');
              }
            }
          }
        } catch (error) {
          console.error('Error fetching cancel requests:', error.message, error.stack);
          consecutiveFetchFailures++;
          console.log('Consecutive fetch failures:', consecutiveFetchFailures);
          if (consecutiveFetchFailures >= MAX_CONSECUTIVE_FAILURES) {
            console.error('Too many consecutive fetch failures, stopping polling');
            if (pollingInterval) {
              clearInterval(pollingInterval);
              pollingInterval = null;
              alert('Unable to fetch notifications due to repeated server errors. Please contact support.');
            }
          }
        }
      }

      function handleLogout() {
        console.log('Logout initiated');
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/login.html'; // Adjust this URL as needed
      }

      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        handleLogout();
      });

      cancelRequests = [
        {
          id: 1,
          patients: { first_name: 'John', last_name: 'Doe' },
          appointment_date: new Date().toISOString(),
          services: { name: 'Dental Checkup' },
          pending_action: 'cancel'
        }
      ];
      updateCancelRequests();
    })();
  </script>
</body>
</html>