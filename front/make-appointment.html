<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Balane-Saspa Dental Clinic - Make an Appointment</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <link href="assets/img/icon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <link href="assets/css/main.css" rel="stylesheet">

  <style>
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    #loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .flatpickr-input {
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      background-color: #fff;
    }

    .flatpickr-day.disabled,
    .time-slot.disabled {
      background-color: #e9ecef !important;
      color: #6c757d !important;
      cursor: not-allowed !important;
    }

    .picker-container {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .flatpickr-calendar {
      margin: 0;
    }

    .time-picker {
      width: 100px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .time-picker-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .time-picker-slots {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .time-slot {
      padding: 5px;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      background-color: #fff;
      transition: background-color 0.2s;
    }

    .time-slot.selected {
      background-color: #007bff;
      color: #fff;
    }

    .time-slot:hover:not(.disabled) {
      background-color: #f8f9fa;
    }

    #appointment-restriction-message {
      margin-bottom: 15px;
      display: none;
    }

    /* Added styling for image display */
    #service-container img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div id="loading-overlay">
    <div id="loading-spinner"></div>
  </div>

  <header id="header" class="header sticky-top">
    <div class="topbar d-flex align-items-center">
      <div class="container">
        <div class="row">
          <div class="col-6 d-flex align-items-center justify-content-center justify-content-md-start">
            <i class="bi bi-clock me-1"></i> Mon - Sat, 9AM to 4PM
          </div>
          <div class="col-6 d-flex align-items-center justify-content-center justify-content-md-end">
            <i class="bi bi-phone me-1"></i> +63 920 797 6690
          </div>
        </div>
      </div>
    </div>

    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center justify-content-end">
        <a href="index.html" class="logo d-flex align-items-center me-auto">
          <img src="assets/img/logo.jpeg" alt="">
        </a>

        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="index.html#home">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#services">Services</a></li>
            <li><a href="index.html#doctors">Doctors</a></li>
            <li><a href="index.html#contact">Contact</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li id="appointment-link">
              <a href="make-appointment.html" style="
                    justify-content: center;
                    align-items: center;
                    padding: 10px;
                    text-align: center;
                    width: 150px;
                    height: 40px;
                    background-color: #84548c;
                    color: white;
                    font-size: 14px;
                    border-radius: 5px;
                    cursor: pointer;
                    transition: background 0.3s ease-in-out;">
                Appointment
              </a>
            </li>
          </ul>
          <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <main class="main">
    <section id="make-appointment" class="section">
      <div class="container section-title" data-aos="fade-up">
        <h2>Make an Appointment</h2>
        <p>Book your dental appointment with ease. Select a service, date, and time, and we’ll handle the rest!</p>
      </div>

      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div id="appointment-restriction-message" class="alert alert-warning"></div>
            <form id="appointment-form" class="php-email-form">
              <div class="row gy-4">
                <div class="col-md-12">
                  <label for="service">Service</label>
                  <select id="service" name="service" class="form-control" required>
                    <option value="">Select a service</option>
                  </select>
                </div>

                <div class="col-md-12">
                  <div id="service-container" class="row justify-content-center" style="display: none;">
                    <span id="service-image"></span>
                  </div>
                </div>
                <div class="col-md-12">
                  <div id="service-description" class="alert alert-info" style="display: none;">
                    <strong>Description:</strong> <span id="service-description-text"></span>
                  </div>
                </div>

                <div class="col-md-12">
                  <label for="appointment-date">Appointment Date and Time</label>
                  <input type="text" id="appointment-date" name="appointment-date" class="form-control" required>
                </div>

                <div class="col-md-12">
                  <label for="notes">Notes (Optional)</label>
                  <textarea id="notes" name="notes" class="form-control" rows="4"
                    placeholder="Any additional information or requests"></textarea>
                </div>

                <div class="col-md-12 text-center">
                  <div class="loading" style="display: none;">Loading</div>
                  <div class="error-message" style="display: none;"></div>
                  <div class="sent-message" style="display: none;">Your appointment request has been submitted. Awaiting
                    admin confirmation.</div>
                  <button class="custom-book-btn" type="submit">BOOK APPOINTMENT</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <section id="services" class="services section">
      <div class="container section-title" data-aos="fade-up">
        <h2>Our Services</h2>
        <h3>Affordable and Quality Dental Care Services</h3>
      </div>

      <div class="container">
        <div class="row gy-3 justify-content-center" id="services-container">
          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Consultation</h3>
              <div class="card">
                <img src="assets/img/services/consultation.jpg" alt="Consultation" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">examination and discussion about your oral health</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Oral Prophylaxis</h3>
              <div class="card">
                <img src="assets/img/services/oralprophylaxis.jpg" alt="Oral Prophylaxis"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Light</p>
                  <p class="card-des">Moderate</p>
                  <p class="card-des">Heavy</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Restorations Temporary Filling</h3>
              <div class="card">
                <img src="assets/img/services/restorationtemporarydentalfillings.jpg"
                  alt="Restorations Temporary Filling" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Small</p>
                  <p class="card-des">Medium</p>
                  <p class="card-des">Large</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Composite Filling</h3>
              <div class="card">
                <img src="assets/img/services/compositefilling.jpg" alt="Composite Filling"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Small</p>
                  <p class="card-des">Medium</p>
                  <p class="card-des">Large</p>
                  <p class="card-des">Anterior</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Surgery Extraction</h3>
              <div class="card">
                <img src="assets/img/services/surgicaltoothextractions.jpg" alt="Surgery Extraction"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Deciduous ant/post</p>
                  <p class="card-des">Anterior</p>
                  <p class="card-des">Posterior</p>
                  <p class="card-des">Canine</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-visible" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Special Case</h3>
              <div class="card">
                <img src="assets/img/services/specialcase.jpg" alt="Special Case" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Mesio/Distoangular</p>
                  <p class="card-des">Upright position</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 text-center mt-4 mb-4">
            <button id="see-more-btn" class="btn btn-primary">See More</button>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Prosthodontic</h3>
              <div class="card">
                <img src="assets/img/services/prosthodontic.jpg" alt="Prosthodontic" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Removable Partial Ordinary</p>
                  <p class="card-des">Acrylic/Stayplate</p>
                  <p class="card-des">1-2, 3-4, or 5 or more units plastic</p>
                  <p class="card-des">Wire clasp</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Casted Metal</h3>
              <div class="card">
                <img src="assets/img/services/castedmetalunilateral.jpg" alt="Casted Metal"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Unilateral</p>
                  <p class="card-des">Bilateral</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Jacket Crown</h3>
              <div class="card">
                <img src="assets/img/services/jacketcrown.jpg" alt="Jacket Crown" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Plastic w/out metal backing</p>
                  <p class="card-des">Porcelain fused to metal</p>
                  <p class="card-des">Tilite, Ceramage</p>
                  <p class="card-des">Emax, Zirconia</p>
                  <p class="card-des">Anterior or Posterior</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Laminates</h3>
              <div class="card">
                <img src="assets/img/services/laminates.jpg" alt="Laminates" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Anterior</p>
                  <p class="card-des">Posterior</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Veneers</h3>
              <div class="card">
                <img src="assets/img/services/veneer.jpg" alt="Veneers" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Anterior</p>
                  <p class="card-des">Posterior</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Complete Denture</h3>
              <div class="card">
                <img src="assets/img/services/completedenture.jpg" alt="Complete Denture"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Plastic new ace</p>
                  <p class="card-des">New ace px</p>
                  <p class="card-des">Bioform</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Flexite</h3>
              <div class="card">
                <img src="assets/img/services/flexite.jpg" alt="Flexite" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Unilateral/Bilateral</p>
                  <p class="card-des">Anteropostero</p>
                  <p class="card-des">Up/down,</p>
                  <p class="card-des">Up/down w/ pontic</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Retainers</h3>
              <div class="card">
                <img src="assets/img/services/retainer.png" alt="Retainers" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Up/down,</p>
                  <p class="card-des">Up/down w/ pontic</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Repair of Denture</h3>
              <div class="card">
                <img src="assets/img/services/rapairdenture.jpg" alt="Repair of Denture"
                  style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Rebasing u/l</p>
                  <p class="card-des">Relining u/l</p>
                  <p class="card-des">Crack denture</p>
                  <p class="card-des">Crown recementation</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Fiber Post</h3>
              <div class="card">
                <img src="assets/img/services/fiberpost.jpg" alt="Fiber Post" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Anterior</p>
                  <p class="card-des">Posterior</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Root Canal</h3>
              <div class="card">
                <img src="assets/img/services/rootcanal.jpeg" alt="Root Canal" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Mono rooted</p>
                  <p class="card-des">Multi rooted/canal</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Pediatrics</h3>
              <div class="card">
                <img src="assets/img/services/pediatrics.jpeg" alt="Pediatrics" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">OP and Fluoride</p>
                  <p class="card-des">Pulpotomy</p>
                  <p class="card-des">Stainless steel crown</p>
                  <p class="card-des">Strip off crown</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Sealant</h3>
              <div class="card">
                <img src="assets/img/services/sealant.jpg" alt="Sealant" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Premolar</p>
                  <p class="card-des">Molar</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>Orthodontics</h3>
              <div class="card">
                <img src="assets/img/services/orthodontics.jpeg" alt="Orthodontics" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Conventional</p>
                  <p class="card-des">Self ligating</p>
                  <p class="card-des">(depends on severity of the case)</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4 col-md-6 service-card-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="service-item position-relative">
              <h3>CNDA Pricelist</h3>
              <div class="card">
                <img src="assets/img/cndapricelist.jpg" alt="Pricelist" style="width: 100%; height: auto;">
                <div class="card__content">
                  <p class="card-des">Visit the clinic to see more</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer id="footer" class="footer light-background">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="index.html" class="logo d-flex align-items-center">
            <span class="sitename">Balane-Saspa Dental Clinic</span>
          </a>
          <div class="footer-contact pt-3">
            <p>4X94+XQ2, Bagasbas Road, Daet</p>
            <p>Camarines Norte, Philippines</p>
            <p class="mt-3"><strong>Phone:</strong> <span>+63 920 797 6690</span></p>
            <p><strong>Email:</strong> <span>dmdannsaspa@yahoo.com</span></p>
            <p><strong>Monday - Saturday, 9AM to 4PM</strong></p>
          </div>
        </div>
      </div>
    </div>

    <div class="container copyright text-center mt-4">
      <p>© <span>Copyright</span> <strong class="px-1 sitename">2025</strong> <span>All Rights Reserved</span></p>
      <div class="credits">
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade | Code Clipse</a>
      </div>
    </div>
  </footer>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    AOS.init();

    // Utility functions
    const showLoading = () => document.getElementById('loading-overlay').style.display = 'flex';
    const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';

    const tryAutoLogin = async () => {
      try {
        const response = await fetch('/auth/auto-login', { method: 'POST', credentials: 'include' });
        if (!response.ok) throw new Error(`Auto-login failed: ${response.statusText}`);
        const data = await response.json();
        return data.success;
      } catch (err) {
        console.error('Auto-login error:', err);
        return false;
      }
    };

    const checkAuth = async () => {
      try {
        const response = await fetch('/check-auth', { credentials: 'include' });
        if (!response.ok) throw new Error(`Failed to check auth: ${response.statusText}`);
        return await response.json();
      } catch (err) {
        console.error('Error checking auth:', err);
        throw err;
      }
    };

    const fetchServices = async () => {
      try {
        const response = await fetch('/api/services', { credentials: 'include' });
        if (!response.ok) {
          if (response.status === 401) throw new Error('Unauthorized: Please log in again.');
          throw new Error(`Failed to fetch services: ${response.statusText}`);
        }
        const data = await response.json();
        return Array.isArray(data.services) ? data.services : (Array.isArray(data) ? data : []);
      } catch (err) {
        console.error('Error fetching services:', err);
        throw err;
      }
    };

    const fetchUserAppointments = async () => {
      try {
        const response = await fetch('/api/appointments', { credentials: 'include' });
        if (!response.ok) {
          if (response.status === 401) throw new Error('Unauthorized: Please log in again.');
          throw new Error(`Failed to fetch user appointments: ${response.statusText}`);
        }
        const data = await response.json();
        return Array.isArray(data.appointments) ? data.appointments : [];
      } catch (err) {
        console.error('Error fetching user appointments:', err);
        throw err;
      }
    };

    const fetchBookedAppointments = async () => {
      try {
        const response = await fetch('/api/appointments/booked', { credentials: 'include' });
        if (!response.ok) {
          if (response.status === 401) throw new Error('Unauthorized: Please log in again.');
          throw new Error(`Failed to fetch booked appointments: ${response.statusText}`);
        }
        const data = await response.json();
        return Array.isArray(data.appointments) ? data.appointments : [];
      } catch (err) {
        console.error('Error fetching booked appointments:', err);
        throw err;
      }
    };

    const populateServices = async (services) => {
      const serviceSelect = document.getElementById('service');
      const serviceDescription = document.getElementById('service-description');
      const serviceDescriptionText = document.getElementById('service-description-text');
      const serviceContainer = document.getElementById('service-container');
      const serviceImageSpan = document.getElementById('service-image');

      // Map HTML services for image lookup with normalized keys
      let serviceItems = document.querySelectorAll('#services-container .service-item');
      let serviceMap = {};
      serviceItems.forEach(item => {
        let serviceName = item.querySelector('h3').textContent.trim().toLowerCase(); // Normalize
        serviceMap[serviceName] = item;
      });

      if (!services || !Array.isArray(services) || services.length === 0) {
        serviceSelect.innerHTML = '<option value="">No services available</option>';
        return;
      }

      const serviceDescriptions = {};
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service.id;
        option.textContent = service.name;
        serviceSelect.appendChild(option);
        serviceDescriptions[service.id] = service.description || 'No description available';
      });

      serviceSelect.addEventListener('change', function () {
        const selectedServiceId = this.value;
        if (selectedServiceId && serviceDescriptions[selectedServiceId]) {
          // Update description from API
          serviceDescriptionText.innerHTML = serviceDescriptions[selectedServiceId].replace(/\n/g, '<br>');
          serviceDescription.style.display = 'block';

          // Update image from HTML
          const selectedServiceName = this.options[this.selectedIndex].textContent.trim().toLowerCase(); // Normalize
          const item = serviceMap[selectedServiceName];
          if (item) {
            let imgSrc = item.querySelector('.card img').src;
            serviceImageSpan.innerHTML = `<img src="${imgSrc}" alt="${selectedServiceName}">`;
            serviceContainer.style.display = 'block';
          } else {
            console.error("Service image not found for:", selectedServiceName, "Available keys:", Object.keys(serviceMap));
            serviceContainer.style.display = 'none'; // Hide image container if no match
          }
        } else {
          serviceDescription.style.display = 'none';
          serviceContainer.style.display = 'none';
        }
      });

      // Trigger initial state
      if (serviceSelect.value) {
        serviceSelect.dispatchEvent(new Event('change'));
      }
    };

    const initializeDatePicker = (bookedAppointments) => {
      const bookedTimes = Array.isArray(bookedAppointments) ? bookedAppointments.map(appointment => {
        const date = new Date(appointment.appointment_date);
        if (isNaN(date.getTime())) return null;
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:00`;
      }).filter(time => time !== null) : [];

      const availableHours = [9, 10, 11, 12, 13, 14, 15, 16];
      flatpickr('#appointment-date', {
        dateFormat: "Y-m-d h K",
        minDate: "today",
        inline: true,
        disable: [
          function (date) {
            const now = new Date();
            const day = date.getDay();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            if (day === 0) return true;
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            if (dateStr === todayStr && now.getHours() >= 15) return true;
            return availableHours.every(hour => bookedTimes.includes(`${dateStr} ${hour.toString().padStart(2, '0')}:00`));
          }
        ],
        onReady: (selectedDates, dateStr, instance) => {
          const calendarContainer = instance.calendarContainer;
          calendarContainer.classList.add('flatpickr-calendar');
          const pickerContainer = document.createElement('div');
          pickerContainer.className = 'picker-container';
          calendarContainer.parentNode.insertBefore(pickerContainer, calendarContainer);  
          pickerContainer.appendChild(calendarContainer);

          const timePicker = document.createElement('div');
          timePicker.className = 'time-picker';
          timePicker.innerHTML = '<div class="time-picker-header">Time</div><div class="time-picker-slots"></div>';
          pickerContainer.appendChild(timePicker);

          const timeSlotsContainer = timePicker.querySelector('.time-picker-slots');
          const times = [
            { hour: 9, label: '9 AM' }, { hour: 10, label: '10 AM' },
            { hour: 11, label: '11 AM' }, { hour: 12, label: '12 PM' },
            { hour: 13, label: '1 PM' }, { hour: 14, label: '2 PM' },
            { hour: 15, label: '3 PM' }, { hour: 16, label: '4 PM' }
          ];
          times.forEach(time => {
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.textContent = time.label;
            slot.dataset.hour = time.hour;
            timeSlotsContainer.appendChild(slot);
          });
        },
        onDayCreate: (dObj, dStr, fp, dayElem) => {
          const now = new Date();
          const day = dayElem.dateObj.getDay();
          const dateStr = `${dayElem.dateObj.getFullYear()}-${String(dayElem.dateObj.getMonth() + 1).padStart(2, '0')}-${String(dayElem.dateObj.getDate()).padStart(2, '0')}`;
          const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
          const isFullyBooked = availableHours.every(hour => bookedTimes.includes(`${dateStr} ${hour.toString().padStart(2, '0')}:00`));
          if (day === 0 || isFullyBooked || (dateStr === todayStr && now.getHours() >= 15)) {
            dayElem.classList.add('disabled');
          }
        },
        onChange: (selectedDates, dateStr, instance) => {
          const selectedDate = selectedDates[0];
          if (!selectedDate) return;

          const dateStrPart = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
          const timePicker = instance.calendarContainer.parentNode.querySelector('.time-picker');
          const timeSlots = timePicker.querySelectorAll('.time-slot');

          timeSlots.forEach(slot => {
            const hour = parseInt(slot.dataset.hour);
            const timeStr = `${dateStrPart} ${hour.toString().padStart(2, '0')}:00`;
            const isBooked = bookedTimes.includes(timeStr);

            slot.classList.remove('selected', 'disabled');
            slot.style.pointerEvents = 'auto';

            if (isBooked) {
              slot.classList.add('disabled');
            } else {
              slot.onclick = () => {
                timeSlots.forEach(s => s.classList.remove('selected'));
                slot.classList.add('selected');
                selectedDate.setHours(hour, 0, 0, 0);
                instance.setDate(selectedDate);
              };
            }
          });

          const firstAvailable = Array.from(timeSlots).find(slot => !slot.classList.contains('disabled'));
          if (firstAvailable && !timePicker.querySelector('.selected')) {
            firstAvailable.click();
          } else if (!firstAvailable) {
            instance.clear();
            Swal.fire({
              title: "No Availability",
              text: "No available times for this date.",
              icon: "warning",
              confirmButtonText: "OK"
            }).then(() => {
              timePicker.querySelector('.selected')?.classList.remove('selected');
              instance.clear();
            });
          }
        }
      });
    };

    const validateAppointmentDate = (date, bookedAppointments) => {
      const [datePart, hourPart, period] = date.split(' ');
      let hour = parseInt(hourPart);
      if (period === 'PM' && hour !== 12) hour += 12;
      if (period === 'AM' && hour === 12) hour = 0;
      const selectedDate = new Date(`${datePart}T${hour.toString().padStart(2, '0')}:00`);
      const selectedStr = `${datePart} ${hour.toString().padStart(2, '0')}:00`;
      const now = new Date();
      const day = selectedDate.getDay();
      const hour24 = selectedDate.getHours();
      const bookedTimes = Array.isArray(bookedAppointments) ? bookedAppointments.map(appointment => {
        const d = new Date(appointment.appointment_date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:00`;
      }) : [];

      if (selectedDate <= now) return 'Please select a future date and time.';
      if (day === 0) return 'Appointments are not available on Sundays.';
      if (hour24 < 9 || hour24 > 16) return 'Appointments are only available between 9 AM and 4 PM.';
      if (bookedTimes.includes(selectedStr)) return 'This time slot is already booked.';
      return null;
    };

    const convertToISO = (dateStr) => {
      const [datePart, hourPart, period] = dateStr.split(' ');
      let hour = parseInt(hourPart);
      if (period === 'PM' && hour !== 12) hour += 12;
      if (period === 'AM' && hour === 12) hour = 0;
      return `${datePart}T${hour.toString().padStart(2, '0')}:00:00Z`;
    };

    const checkAppointmentRestrictions = async (appointments) => {
      const now = new Date();
      const restrictionMessage = document.getElementById('appointment-restriction-message');
      const form = document.getElementById('appointment-form');

      const activeAppointment = appointments.find(app => {
        const appDate = new Date(app.appointment_date);
        const status = typeof app.status === 'string' ? app.status.toLowerCase() : '';
        return (status === 'pending' || (status === 'confirmed' && appDate >= now));
      });

      if (activeAppointment) {
        restrictionMessage.innerHTML =
          'You cannot book a new appointment while you have an active appointment. Please wait until your appointment is completed or cancelled.<br><br>' +
          'You can edit your appointment in your profile if you need.';
        restrictionMessage.style.display = 'block';
        form.style.display = 'none';
        return false;
      }

      const latestAppointment = appointments.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))[0];
      if (latestAppointment) {
        const updatedAt = new Date(latestAppointment.updated_at);
        let cooldownDays = 0;
        let cooldownReason = '';
        const status = typeof latestAppointment.status === 'string' ? latestAppointment.status.toLowerCase() : '';

        if (status === 'cancelled') {
          cooldownDays = 3;
          cooldownReason = 'cancelled';
        }

        if (cooldownDays > 0) {
          const cooldownEnd = new Date(updatedAt);
          cooldownEnd.setDate(updatedAt.getDate() + cooldownDays);
          const daysRemaining = Math.ceil((cooldownEnd - now) / (1000 * 60 * 60 * 24));

          if (now < cooldownEnd) {
            restrictionMessage.textContent = `You are under a ${cooldownDays}-day cooldown period because your last appointment was ${cooldownReason}. You can book a new appointment after ${cooldownEnd.toLocaleDateString()}. (${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining)`;
            restrictionMessage.style.display = 'block';
            form.style.display = 'none';
            return false;
          }
        }

        if (status === 'confirmed' && new Date(latestAppointment.appointment_date) < now) {
          restrictionMessage.style.display = 'none';
          form.style.display = 'block';
          return true;
        }
      }

      restrictionMessage.style.display = 'none';
      form.style.display = 'block';
      return true;
    };

    document.addEventListener('DOMContentLoaded', async function () {
      showLoading();
      try {
        let authData = await checkAuth();

        if (!authData.isLoggedIn) {
          const autoLoginSuccess = await tryAutoLogin();
          if (autoLoginSuccess) authData = await checkAuth();
        }

        if (!authData.isLoggedIn) {
          hideLoading();
          await Swal.fire({
            title: "Not Logged In",
            text: "Please log in to make an appointment.",
            icon: "warning",
            confirmButtonText: "OK"
          });
          window.location.replace('pages-login.html');
          return;
        }

        const services = await fetchServices();
        await populateServices(services);

        const userAppointments = await fetchUserAppointments();
        const canBook = await checkAppointmentRestrictions(userAppointments);
        if (!canBook) return;

        const bookedAppointments = await fetchBookedAppointments();
        initializeDatePicker(bookedAppointments);

        document.getElementById('appointment-form').addEventListener('submit', async function (e) {
          e.preventDefault();

          const bookingAlert = Swal.fire({
            title: 'Submitting Appointment',
            text: 'Please wait while we process your request...',
            icon: 'info',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          const serviceId = document.getElementById('service').value;
          const appointmentDate = document.getElementById('appointment-date').value;
          const notes = document.getElementById('notes').value;

          if (!serviceId || !appointmentDate) {
            await Swal.close();
            hideLoading();
            await Swal.fire({
              title: "Pick a date",
              text: "Please fill in available data for your appointment.",
              icon: "warning",
              confirmButtonText: "OK",  
              showConfirmButton: true
            });
            return;
          }

          const dateValidationError = validateAppointmentDate(appointmentDate, bookedAppointments);
          if (dateValidationError) {
            await Swal.close();
            hideLoading();
            await Swal.fire({
              title: "Invalid Date",
              text: dateValidationError,
              icon: "warning",
              confirmButtonText: "OK"
            });
            return;
          }

          const isoAppointmentDate = convertToISO(appointmentDate);

          try {
            const response = await fetch('/api/appointments', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: authData.userId,
                appointment_date: isoAppointmentDate,
                service_id: serviceId,
                notes: notes,
              }),
            });

            if (response.status === 401) {
              await Swal.close();
              await Swal.fire({
                title: "Session Expired",
                text: "Your session has expired. Please log in again.",
                icon: "warning",
                confirmButtonText: "OK",
                showConfirmButton: true
              });
              window.location.replace('pages-login.html');
              return;
            }

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Failed to book appointment');
            }

            const result = await response.json();
            await Swal.close();
            await Swal.fire({
              title: "Success",
              text: result.message || "Appointment booked successfully!",
              icon: "success",
              confirmButtonText: "OK",
              showConfirmButton: true
            });

            const authCheck = await checkAuth();
            if (authCheck.isLoggedIn) {
              window.location.href = 'profile.html';
            } else {
              hideLoading();
              await Swal.fire({
                title: "Session Expired",
                text: "Session expired after booking. Please log in again.",
                icon: "warning",
                confirmButtonText: "OK",
                showConfirmButton: true
              });
              window.location.replace('pages-login.html');
            }
          } catch (err) {
            console.error('Error booking appointment:', err);
            await Swal.close();
            hideLoading();
            await Swal.fire({
              title: "Error!",
              text: "Failed to book appointment: " + err.message,
              icon: "error",
              confirmButtonText: "OK",
              showConfirmButton: true
            });
          } finally {
            hideLoading();
          }
        });
      } catch (err) {
        console.error('Error initializing page:', err);
        await Swal.fire({
          title: "Error!",
          text: err.message || "An error occurred while loading the page. Please try again later.",
          icon: "error",
          confirmButtonText: "OK"
        });
      } finally {
        hideLoading();
      }
    });
  </script>

  <script src="assets/js/main.js"></script>
  <script src="assets/js/see-more.js"></script>
  <script src="assest/js/card-overlay.js"></script>
</body>

</html>